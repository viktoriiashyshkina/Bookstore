<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
    }

    header {
        width: 100%;
        height: 110px;
        position: relative;
        overflow: hidden;
    }

    header img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    nav {
        display: flex;
        justify-content: space-between;
        padding: 10px 20px;
        background-color: #444;
    }

    nav a {
        color: white;
        text-decoration: none;
        margin: 0 15px;
        padding: 8px 15px;
        border-radius: 5px;
    }

    nav a:hover {
        background-color: #666;
    }

    .nav-left {
        flex: 1;
    }

    .nav-center {
        flex: 2;
        text-align: center;
    }

    .nav-right {
        flex: 1;
        text-align: right;
        display: flex;
        align-items: center;
        justify-content: flex-end;
    }

    .nav-center form {
        display: flex;
        justify-content: center;
    }

    .nav-center input[type="text"] {
        padding: 10px;
        width: 250px;
        border-radius: 5px;
        border: 1px solid #ccc;
    }

    .nav-center button {
        padding: 6px 12px;
        margin-left: 10px;
        background-color: #666;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
    }

    .nav-center button:hover {
        background-color: #555;
    }

    .category-dropdown {
        display: inline-block;
    }

    .category-dropdown select {
        padding: 5px;
        margin-top: 10px;
    }

    .main-content {
        padding: 20px;
    }

<!--        footer {-->
<!--            background-color: #333;-->
<!--            color: white;-->
<!--            text-align: center;-->
<!--            padding: 10px;-->
<!--            position: fixed;-->
<!--            width: 100%;-->
<!--            bottom: 0;-->
<!--        }-->



    section {
        display: none;
    }

    section:target {
        display: block;
    }

    .nav-right img {
        width: 30px;
        height: 30px;
        vertical-align: middle;
    }

        .book-container {
    display: flex;
    align-items: flex-start;
    margin: 20px 0;
    border-bottom: 1px solid #ccc;
    padding-bottom: 20px;
    max-width: 900px;
}

.container {
max-width: 900px;
margin: 0 auto;
}

.book-image {
    width: 100px;
    height: 133px;
    background-color: #f0f0f0;
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.1rem;
    color: #888;
    margin-right: 20px;
}


<!--.book-container {-->
<!--    display: flex;-->
<!--    align-items: flex-start;-->
<!--    margin: 20px 0;-->
<!--    border-bottom: 1px solid #ccc;-->
<!--    padding-bottom: 20px;-->
<!--    max-width: 900px;-->
<!--    position: relative; /* Required for positioning price */-->
<!--}-->

<!--.book-image {-->
<!--    width: 100px;-->
<!--    height: 133px;-->
<!--    background-color: #f0f0f0;-->
<!--    text-align: center;-->
<!--    display: flex;-->
<!--    justify-content: center;-->
<!--    align-items: center;-->
<!--    font-size: 1.1rem;-->
<!--    color: #888;-->
<!--    margin-right: 20px;-->
<!--    position: relative;-->
<!--}-->

.book-container {
display: flex;
align-items: flex-start;
margin: 20px 0;
border-bottom: 1px solid #ccc;
padding-bottom: 20px;
max-width: 900px;
position: relative; /* Required for positioning price */
}

.book-image {
width: 100px;
height: 133px;
background-color: #f0f0f0;
text-align: center;
display: flex;
justify-content: center;
align-items: center;
font-size: 1.1rem;
color: #888;
margin-right: 20px;
position: relative;
}

.book-price {
position: absolute;
top: 0;
right: 0;
font-size: 1.6rem; /* Larger font size */
font-weight: bold; /* Bold text */
color: #444; /* Price color */
background-color: #f9f9f9; /* Optional background for better visibility */
padding: 5px 10px; /* Add padding for spacing */
}

<!--    .book-info {-->
<!--        flex-grow: 1;-->
<!--    }-->

.book-title {
    font-size: 1rem;
    font-weight: bold;
    max-width: 50ch;
    word-wrap: break-word; /* Ensures long words are not split */
    white-space: normal;
    line-height: 1.5;
    margin-bottom: 10px;
}
.book-author {
    color: #666;
    margin-bottom: 10px;
    font-size: 0.75rem;
}

.add-book-container,
.edit-book-container {
    display: none;
    border: 1px solid #ccc;
    padding: 20px;
    margin-top: 20px;
    border-radius: 8px;
    background-color: #f9f9f9;
}

.image-upload {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 15px;
}

.image-upload-frame {
    width: 75px;
    height: 100px;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 1px dashed #888;
    background-color: #f0f0f0;
    cursor: pointer;
    font-size: 2rem;
    color: #666;
    position: relative;
}

.image-upload-content {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
width: 100%;
height: 100%;
}
.upload-icon-container {
position: absolute;
display: flex;
justify-content: center;
align-items: center;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.3);
    opacity: 0;
transition: opacity 0.3s ease;
}

.upload-icon-container:hover {
opacity: 1;
}


.upload-icon {
font-size: 2rem;
color: #666;
}


.image-preview {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
    }

    .pagination-bar {
text-align: center;
margin-top: 20px;
}

.pagination-bar a {
display: inline-block;
margin: 0 5px;
padding: 5px 10px;
text-decoration: none;
color: #444;
background-color: #f0f0f0;
border-radius: 5px;
}

.pagination-bar a:hover {
background-color: #ccc;
}

.pagination-bar .active {
font-weight: bold;
background-color: #444;
color: white;
}

.pagination-bar .prev,
.pagination-bar .next {
font-weight: bold;
}

.pagination-bar .prev:hover,
.pagination-bar .next:hover {
background-color: #ccc;
}

    footer {
background-color: #333;
color: white;
text-align: center;
padding: 20px; /* Increased padding to give some space */
position: relative; /* Ensure footer is at the bottom of content */
width: 100%;
margin-top: 20px; /* Add some margin above footer */
}


  </style>
  <script>



    function setDeleteBookId(bookId) {
    // Update the hidden input with the selected book ID
    document.getElementById('deleteBookId').value = bookId;

    // Optionally log for debugging
    console.log("Book ID set for deletion: ", bookId);
  }



let categoryList = []; // Global array to store categories

// Submit the category from the modal
function submitCategory() {
  const categoryInput = document.getElementById('categoryInput').value.trim();

  if (categoryInput) {
    // Add category to the global list
    categoryList.push(categoryInput);

    // Create a "pill" for the category
    const categoryPill = document.createElement('div');
    categoryPill.className = 'category-pill';
    categoryPill.textContent = categoryInput;

    // Append the pill to the display container
    document.getElementById('categoryDisplayContainer').appendChild(categoryPill);

    // Update the hidden input with the comma-separated list
    const hiddenInput = document.querySelector('input[name="categoryList"]');
    hiddenInput.value = categoryList.join(',');

    // Close the modal after submission
    closeCategoryModal();
  }
}

// Open the category modal
function openCategoryModal() {
  document.getElementById('categoryModal').style.display = 'block';
}

// Close the category modal
function closeCategoryModal() {
  document.getElementById('categoryModal').style.display = 'none';
  document.getElementById('categoryInput').value = ''; // Clear the input field
}

<!--        #basket p {-->
<!--          font-size: 18px;-->
<!--          font-weight: bold;-->
<!--          text-align: center;-->
<!--          margin-top: 20px;-->
<!--        }-->
<!--        .basket-items {-->
<!--          margin-top: 20px;-->
<!--          display: flex;-->
<!--          flex-direction: column;-->
<!--          align-items: center;-->
<!--        }-->
<!--        .basket-items .item {-->
<!--          padding: 10px;-->
<!--          background-color: #EAEAEA;-->
<!--          margin: 5px;-->
<!--          border-radius: 5px;-->
<!--          width: 80%;-->
<!--          text-align: center;-->
<!--        }-->
<!--        .nav-right img {-->
<!--          width: 30px;-->
<!--          height: 30px;-->
<!--          vertical-align: middle;-->
<!--        }-->



let authorList = []; // Global array to store categories

// Submit the author from the modal
function submitAuthor() {
  const authorInput = document.getElementById('authorInput').value.trim();

  if (authorInput) {
    // Add category to the global list
    authorList.push(authorInput);

    // Create a "pill" for the category
    const authorPill = document.createElement('div');
    authorPill.className = 'author-pill';
    authorPill.textContent = authorInput;

    // Append the pill to the display container
    document.getElementById('authorDisplayContainer').appendChild(authorPill);

    // Update the hidden input with the comma-separated list
    const hiddenInput = document.querySelector('input[name="authorList"]');
    hiddenInput.value = authorList.join(',');

    // Close the modal after submission
    closeAuthorModal();
  }
}

// Open the category modal
function openAuthorModal() {
  document.getElementById('authorModal').style.display = 'block';
}

// Close the category modal
function closeAuthorModal() {
  document.getElementById('authorModal').style.display = 'none';
  document.getElementById('authorInput').value = ''; // Clear the input field
}




function openEditCategoryModal(bookId) {
  // Open the category modal for the given book
  document.getElementById(`editCategoryModal-${bookId}`).style.display = 'block';
}


function closeEditCategoryModal(bookId) {
  // Close the category modal for the given book
  document.getElementById(`editCategoryModal-${bookId}`).style.display = 'none';
  // Clear the category input
  document.getElementById(`editCategoryInput-${bookId}`).value = '';
}





function submitEditCategory(bookId) {
  const categoryInput = document.getElementById(`editCategoryInput-${bookId}`).value.trim();
  if (categoryInput) {


    // Get the hidden input storing the list of categories
    const hiddenInput = document.getElementById(`editCategoryList-${bookId}`);
    // Parse the existing categories, append the new one, and update the input value
    let categories = hiddenInput.value ? hiddenInput.value.split(',') : [];
    categories.push(categoryInput);
    hiddenInput.value = categories.join(',');

    // Close the modal
    closeEditCategoryModal(bookId);
    }
}



function updateCategoryList(bookId) {
  // Get the input fields in the editCategoryDisplayContainer
  const categoryInputs = document.querySelectorAll(`#editCategoryDisplayContainer-${bookId} input.form-control`);

  // Create an array of the current category values
  const categoryValues = Array.from(categoryInputs).map(input => input.value);

  // Update the editCategoryList input field with the new values
  const editCategoryListInput = document.getElementById(`editCategoryList-${bookId}`);
  editCategoryListInput.value = categoryValues.join(',');
}



function openEditAuthorModal(bookId) {
  // Open the author modal for the given book
  document.getElementById(`editAuthorModal-${bookId}`).style.display = 'block';
}

function closeEditAuthorModal(bookId) {
  // Close the author modal for the given book
  document.getElementById(`editAuthorModal-${bookId}`).style.display = 'none';
  // Clear the author input
  document.getElementById(`editAuthorInput-${bookId}`).value = '';
}

function submitEditAuthor(bookId) {
  const authorInput = document.getElementById(`editAuthorInput-${bookId}`).value.trim();
  if (authorInput) {

    // Get the hidden input storing the list of authors
    const hiddenInput = document.querySelector(`[name="editAuthorList-${bookId}"]`);
    // Parse the existing authors, append the new one, and update the input value
    let authors = hiddenInput.value ? hiddenInput.value.split(',') : [];
    authors.push(authorInput);
    hiddenInput.value = authors.join(',');

    // Close the modal
    closeEditAuthorModal(bookId);
  }
}




    // Toggle Add Book Form visibility
    function toggleAddBook() {
        const container = document.getElementById("addBookContainer");
        container.style.display = container.style.display === "none" ? "block" : "none";
    }


    // Toggle Edit Book Form visibility for a specific book
    function toggleEditBook(bookId) {
        const editContainer = document.getElementById(`editBookContainer-${bookId}`);

        // Toggle the visibility of the corresponding edit container
        if (editContainer) {
            const isCurrentlyVisible = editContainer.style.display === "block";
            editContainer.style.display = isCurrentlyVisible ? "none" : "block";
        }
    }





    // Preview the uploaded image
    function previewImage(event, previewId) {
        const reader = new FileReader();
        reader.onload = function() {
            const output = document.getElementById(previewId);
            output.src = reader.result;
            output.style.display = 'block';
        };
        reader.readAsDataURL(event.target.files[0]);
    }
  </script>
</head>
<body>

<header>
  <img th:src="@{/images/banner.jpg}" alt="Welcome to the Bookstore" src=""></header>

<nav>
  <div class="nav-left">
    <a th:href="@{/home}">Home</a>
  </div>


  <div class="nav-center">
    <form action="/searchResults" method="get">
      <input type="text" name="query" placeholder="Search books..." required>
      <button type="submit">Search</button>
    </form>
  </div>

  <div class="nav-right">
    <!-- Check if the user is logged in -->
    <div th:if="${#authentication.principal != 'anonymousUser'}">
      <span>Welcome, <strong th:text="${#authentication.name}">User</strong>!</span>
      <p>Your account balance is: $<span th:text="${balance}">0.00</span></p>



      <a href="/logged-in">My Account</a>
      <a href="/logout">Logout</a>
    </div>

    <!-- Show Login/Sign Up buttons if the user is not logged in -->
    <div th:if="${#authentication.principal == 'anonymousUser'}">
      <a href="/login#signup">Sign Up</a>
      <a href="/login#login">Login</a>
    </div>



    <!-- Shopping Basket Icon -->
    <a href="/basket">
      <img th:src="@{/images/purchase.png}" alt="Shopping Basket" style="width: 30px; height: 30px;">
    </a>
  </div>


</nav>


<div class="container">

  <!-- Add Book Button -->
  <div class="d-flex justify-content-start">
    <button type="button" class="btn btn-primary mb-3" onclick="toggleAddBook()">+ Add Book</button>
  </div>

<!--   Add Book Form-->
  <div id="addBookContainer" class="add-book-container">
    <form th:action="@{/books/add}" method="post" enctype="multipart/form-data">
      <div class="image-upload">
        <label for="imageUpload" class="image-upload-frame">
          <span id="uploadIcon" style="display: block;">+</span>
          <img id="imagePreview" class="image-preview" alt="Preview">
        </label>
        <input type="file" id="imageUpload" name="image" accept="image/*" onchange="previewImage(event, 'imagePreview')" style="display: none;">
      </div>

      <input type="text" class="form-control mb-3" name="title" placeholder="Add title" required>


      <div class="form-group">
        <!-- Container for displaying added authors -->
        <div id="authorDisplayContainer" class="d-flex flex-wrap mb-3"></div>

        <!-- + Category Button -->
        <button type="button" class="btn btn-secondary" onclick="openAuthorModal()">+ Author</button>

        <!-- Hidden input to store the final list of categories -->
        <input  type="hidden" name="authorList">
      </div>

      <!-- Modal for entering an author-->
      <div id="authorModal" class="modal" tabindex="-1" style="display: none;">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Add Author</h5>
              <button type="button" class="btn-close" onclick="closeAuthorModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Please enter an author:</p>
              <input type="text" id="authorInput" class="form-control" placeholder="Enter author">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" onclick="submitAuthor()">Submit</button>
            </div>
          </div>
        </div>
      </div>



      <div class="form-group">
        <!-- Container for displaying added categories -->
        <div id="categoryDisplayContainer" class="d-flex flex-wrap mb-3"></div>

        <!-- + Category Button -->
        <button type="button" class="btn btn-secondary mb-4" onclick="openCategoryModal()">+ Category</button>

        <!-- Hidden input to store the final list of categories -->
        <input type="hidden" name="categoryList">
      </div>

      <!-- Modal for entering a category -->
      <div id="categoryModal" class="modal" tabindex="-1" style="display: none;">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Add Category</h5>
              <button type="button" class="btn-close" onclick="closeCategoryModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Please enter a category:</p>
              <input type="text" id="categoryInput" class="form-control" placeholder="Enter category">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" onclick="submitCategory()">Submit</button>
            </div>
          </div>
        </div>
      </div>


      <textarea class="form-control mb-3" name="description" placeholder="Add description"></textarea>
      <input type="text" class="form-control mb-3" name="isbn" placeholder="Add ISBN" required>
      <input type="number" step="0.01" class="form-control mb-3" name="price" placeholder="Add price" required>

      <button type="submit" class="btn btn-primary">Save Book</button>
    </form>
  </div>



  <!-- Display Books -->
  <div th:each="book : ${books}" class="book-container">
    <div class="book-image" th:if="${book.image == null}">No picture</div>
<!--    <img th:src="@{${book.image}}" th:if="${book.image != null}" class="book-image" alt="Book Image">-->
    <img th:src="'data:image/jpeg;base64,' + ${book.imageDataBase64}"  th:if="${book.image != null}" class="book-image" alt="Book Image">

    <div class="book-info">
      <div class="book-title" th:text="${book.title}">Book Title</div>
      <p>by
        <span th:each="author, iterStat : ${book.author}"
              th:utext="${author + (iterStat.last ? '' : ', ')}"></span>
      </p>
      <p>Categories:
        <span th:each="category : ${book.category}"
              th:utext="${category + '&nbsp;&nbsp;&nbsp;'}"></span>
      </p>
      <p>ISBN: <span th:text="${book.isbn}">ISBN</span></p>
      <p>Price: $<span th:text="${book.price}">Price</span></p>
      <p>Id: <span th:text="${book.id}">Id</span></p>
    </div>



    <!-- Edit Book Form (Hidden by Default) -->
    <div th:id="|editBookContainer-${book.id}|" class="edit-book-container">
      <form th:action="@{/books/edit/{id}(id=${book.id})}" method="post" enctype="multipart/form-data">


        <div class="image-upload">
          <label th:for="|editImageUpload-${book.id}|" class="image-upload-frame">
            <div class="image-upload-content">
              <!--            <span style="display: block;">+</span>-->
              <img th:id="|editImagePreview-${book.id}|" th:src="'data:image/jpeg;base64,' + ${book.imageDataBase64}" th:if="${book.image != null}" class="image-preview" alt="Preview" style="display: block;">
              <img th:id="|editImagePreview-${book.id}|" src="#" class="image-preview" alt="Preview" style="display: none;">
              <div class="upload-icon-container">
                <span class="upload-icon">+</span>
              </div>
            </div>
          </label>
          <input type="file" th:id="|editImageUpload-${book.id}|" name="image" accept="image/*" th:onchange="|previewImage(event, 'editImagePreview-${book.id}')|" style="display: none;">
        </div>

        <input type="text" class="form-control mb-3" name="title" th:value="${book.title}" required>

        <div class="form-group d-flex align-items-center" id="displayAuthors">
          <input th:id="|editAuthorList-${book.id}|" class="form-control me-2 mb-4" th:name="|editAuthorList-${book.id}|" th:value="${#strings.arrayJoin(book.author, ',')}">
          <button type="button" class="btn btn-secondary text-nowrap mb-4" th:onclick="|openEditAuthorModal('${book.id}')|">+ Author</button>
        </div>


        <!-- Modal for entering an author -->
        <div th:id="|editAuthorModal-${book.id}|" class="modal" tabindex="-1" style="display: none;">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Add Author</h5>
                <button type="button" class="btn-close" th:onclick="|closeEditAuthorModal('${book.id}')|" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>Please enter an author:</p>
                <input type="text" th:id="|editAuthorInput-${book.id}|" class="form-control" placeholder="Enter author">
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" th:onclick="|submitEditAuthor('${book.id}')|">Submit</button>
              </div>
            </div>
          </div>
        </div>



        <div class="form-group d-flex align-items-center" id="displayCategories">
          <input th:id="|editCategoryList-${book.id}|" class="form-control me-2 mb-4" th:name="|editCategoryList-${book.id}|" th:value="${#strings.arrayJoin(book.category, ',')}">
          <button type="button" class="btn btn-secondary text-nowrap mb-4" th:onclick="|openEditCategoryModal('${book.id}')|">+ Category</button>
        </div>



        <!-- Modal for entering a category -->
        <div th:id="|editCategoryModal-${book.id}|" class="modal" tabindex="-1" style="display: none;">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Add Category</h5>
                <button type="button" class="btn-close" th:onclick="|closeEditCategoryModal('${book.id}')|" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>Please enter a category:</p>
                <input type="text" th:id="|editCategoryInput-${book.id}|" class="form-control" placeholder="Enter category">
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" th:onclick="|submitEditCategory('${book.id}')|">Submit</button>
              </div>
            </div>
          </div>
        </div>


        <textarea class="form-control mb-3" name="description" th:text="${book.description}"></textarea>
        <input type="text" class="form-control mb-3" name="isbn" th:value="${book.isbn}" required>
        <input type="number" step="0.01" class="form-control mb-3" name="price" th:value="${book.price}" required>


          <button type="submit" class="btn btn-primary">Update Book</button>

      </form>
    </div>


    <!-- Button to open the confirmation modal -->
    <div class="d-flex mt-2">
      <button class="btn btn-secondary me-2" th:onclick="|toggleEditBook('${book.id}')|">Edit</button>
            <form th:action="@{/books/delete/{id}(id=${book.id})}" method="post" style="display: inline;">
              <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this book?');">Delete</button>
            </form>
  </div>




  </div>
</div>


<div class="pagination-bar">
    <span th:if="${currentPage > 0}">
        <a th:href="@{'?page=' + (${currentPage - 1}) + '&size=10'}" class="prev">Prev</a>
    </span>

  <!-- Loop through the total pages and create a link for each page -->
  <span th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}">
        <a th:href="@{'?page=' + ${pageNum} + '&size=10'}"
           th:text="${pageNum + 1}"
           th:classappend="${pageNum == currentPage ? 'active' : ''}"></a>
    </span>

  <span th:if="${currentPage < totalPages - 1}">
        <a th:href="@{'?page=' + (${currentPage + 1}) + '&size=10'}" class="next">Next</a>
    </span>
</div>


<footer>
  <p>&copy; 2024 Bookstore. All rights reserved.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
</body>
</html>
